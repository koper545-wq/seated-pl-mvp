// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTH
// ============================================

enum UserType {
  GUEST
  HOST
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  passwordHash  String     @map("password_hash")
  userType      UserType   @default(GUEST) @map("user_type")
  status        UserStatus @default(ACTIVE)
  emailVerified DateTime?  @map("email_verified")
  ageVerified   Boolean    @default(false) @map("age_verified")
  language      String     @default("pl")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  guestProfile GuestProfile?
  hostProfile  HostProfile?
  bookings     Booking[]
  reviews      Review[]       @relation("ReviewAuthor")
  received     Review[]       @relation("ReviewSubject")
  badges       UserBadge[]
  following    HostFollow[]

  // Messaging
  hostConversations  Conversation[] @relation("HostConversations")
  guestConversations Conversation[] @relation("GuestConversations")
  sentMessages       Message[]      @relation("SentMessages")

  @@map("users")
}

model GuestProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique @map("user_id")
  firstName          String?  @map("first_name")
  lastName           String?  @map("last_name")
  bio                String?
  avatarUrl          String?  @map("avatar_url")
  dietaryRestrictions String[] @map("dietary_restrictions")
  allergies          String[]
  xp                 Int      @default(0)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("guest_profiles")
}

model HostProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  businessName        String   @map("business_name")
  description         String?
  avatarUrl           String?  @map("avatar_url")
  coverUrl            String?  @map("cover_url")
  phoneNumber         String?  @map("phone_number")
  city                String   @default("Wroc≈Çaw")
  neighborhood        String?
  cuisineSpecialties  String[] @map("cuisine_specialties")
  socialLinks         Json?    @map("social_links")
  verified            Boolean  @default(false)
  responseRate        Float?   @map("response_rate")
  responseTime        Int?     @map("response_time") // in hours
  onboardingPaid      Boolean  @default(false) @map("onboarding_paid")
  bankAccount         Json?    @map("bank_account")
  // Onboarding fields
  hostSubtype         String?  @map("host_subtype") // "business" | "individual"
  onboardingCompleted Boolean  @default(false) @map("onboarding_completed")
  nip                 String?
  website             String?
  address             Json?    // { street, apartment, postalCode, city }
  contactPerson       Json?    @map("contact_person") // { name, email, phone, position }
  experienceLevel     String?  @map("experience_level") // "yes" | "no" | "professional"
  experienceDetails   String?  @map("experience_details")
  eventTypes          String[] @map("event_types")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  events    Event[]
  followers HostFollow[]

  @@map("host_profiles")
}

model HostFollow {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  hostId    String   @map("host_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  host HostProfile @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@unique([userId, hostId])
  @@map("host_follows")
}

// ============================================
// EVENTS
// ============================================

enum EventType {
  SUPPER_CLUB
  CHEFS_TABLE
  POPUP
  RESTAURANT_COLLAB
  COOKING_CLASS
  WINE_TASTING
  ACTIVE_FOOD
  FARM_EXPERIENCE
  OTHER
}

enum EventStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum BookingMode {
  INSTANT
  MANUAL
}

model Event {
  id                 String      @id @default(cuid())
  hostId             String      @map("host_id")
  title              String
  slug               String      @unique
  description        String
  eventType          EventType   @map("event_type")
  cuisineTags        String[]    @map("cuisine_tags")
  images             String[]
  date               DateTime
  startTime          String      @map("start_time")
  duration           Int         // in minutes
  locationPublic     String      @map("location_public") // neighborhood
  locationFull       String      @map("location_full") // full address
  price              Int         // in PLN grosz (1 PLN = 100)
  capacity           Int
  spotsLeft          Int         @map("spots_left")
  menuDescription    String?     @map("menu_description")
  dietaryOptions     String[]    @map("dietary_options")
  byob               Boolean     @default(false)
  ageRequired        Boolean     @default(true) @map("age_required")
  dressCode          String?     @map("dress_code")
  whatToBring        String?     @map("what_to_bring")
  bookingMode        BookingMode @default(MANUAL) @map("booking_mode")
  cancellationPolicy String?     @map("cancellation_policy")
  languages          String[]    @default(["pl"])
  status             EventStatus @default(DRAFT)
  featured           Boolean     @default(false)
  viewCount          Int         @default(0) @map("view_count")
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  host     HostProfile @relation(fields: [hostId], references: [id], onDelete: Cascade)
  bookings Booking[]
  reviews  Review[]
  waitlist Waitlist[]

  @@index([date])
  @@index([status])
  @@index([eventType])
  @@map("events")
}

// ============================================
// BOOKINGS & PAYMENTS
// ============================================

enum BookingStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model Booking {
  id              String        @id @default(cuid())
  eventId         String        @map("event_id")
  guestId         String        @map("guest_id")
  ticketCount     Int           @default(1) @map("ticket_count")
  totalPrice      Int           @map("total_price") // in PLN grosz
  platformFee     Int           @map("platform_fee") // in PLN grosz
  status          BookingStatus @default(PENDING)
  dietaryInfo     String?       @map("dietary_info")
  specialRequests String?       @map("special_requests")
  emergencyContact String?      @map("emergency_contact")
  approvedAt      DateTime?     @map("approved_at")
  cancelledAt     DateTime?     @map("cancelled_at")
  cancelReason    String?       @map("cancel_reason")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  event        Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guest        User           @relation(fields: [guestId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  conversation Conversation[]

  @@unique([eventId, guestId])
  @@index([status])
  @@map("bookings")
}

enum TransactionType {
  CHARGE
  REFUND
  PAYOUT_FIRST
  PAYOUT_SECOND
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Transaction {
  id               String            @id @default(cuid())
  bookingId        String            @map("booking_id")
  type             TransactionType
  amount           Int               // in PLN grosz
  status           TransactionStatus @default(PENDING)
  stripePaymentId  String?           @map("stripe_payment_id")
  stripeTransferId String?           @map("stripe_transfer_id")
  failureReason    String?           @map("failure_reason")
  processedAt      DateTime?         @map("processed_at")
  createdAt        DateTime          @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([status])
  @@map("transactions")
}

model Waitlist {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  email     String
  userId    String?  @map("user_id")
  notifiedAt DateTime? @map("notified_at")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, email])
  @@map("waitlists")
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id                String   @id @default(cuid())
  eventId           String   @map("event_id")
  authorId          String   @map("author_id")
  subjectId         String   @map("subject_id") // host or guest being reviewed
  overallRating     Int      @map("overall_rating") // 1-5
  foodRating        Int?     @map("food_rating")
  communicationRating Int?   @map("communication_rating")
  valueRating       Int?     @map("value_rating")
  ambianceRating    Int?     @map("ambiance_rating")
  text              String?
  photos            String[]
  isHostReview      Boolean  @default(false) @map("is_host_review") // if true, host reviewing guest
  verifiedAttendee  Boolean  @default(true) @map("verified_attendee")
  helpfulCount      Int      @default(0) @map("helpful_count")
  reported          Boolean  @default(false)
  response          String?
  respondedAt       DateTime? @map("responded_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  author  User  @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  subject User  @relation("ReviewSubject", fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([subjectId])
  @@map("reviews")
}

// ============================================
// EMAIL VERIFICATION
// ============================================

model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

// ============================================
// GAMIFICATION
// ============================================

model Badge {
  id          String      @id @default(cuid())
  name        String      @unique
  namePl      String      @map("name_pl")
  description String
  descriptionPl String    @map("description_pl")
  icon        String
  category    String      // guest, host
  requirement Json        // conditions to earn
  xpReward    Int         @default(0) @map("xp_reward")
  createdAt   DateTime    @default(now()) @map("created_at")

  users UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  badgeId   String   @map("badge_id")
  earnedAt  DateTime @default(now()) @map("earned_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id        String   @id @default(cuid())
  hostId    String   @map("host_id")
  guestId   String   @map("guest_id")
  bookingId String?  @map("booking_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  host     User      @relation("HostConversations", fields: [hostId], references: [id], onDelete: Cascade)
  guest    User      @relation("GuestConversations", fields: [guestId], references: [id], onDelete: Cascade)
  booking  Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  messages Message[]

  @@unique([hostId, guestId])
  @@index([hostId])
  @@index([guestId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  text           String
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}
